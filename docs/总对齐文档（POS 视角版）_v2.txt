——————————————
TopTea – 次卡 · POS 端总整理（操作流程 + 实施现状） V2
更新日期：2025-11-20
——————————————

一、整体目标和原则（POS 视角）
1）核心目标
   在现有 POS 架构上，增量实现“次卡购买”与“次卡核销”闭环。
2）全局基础约束
   • 时间：UTC + DATETIME(6)。
   • 架构：沿用 `pos_helper` / `pos_registry`。
   • 业务：一单一卡、不混单、0 元核销不生成税务发票 (TP)。

二、POS 端操作流程 —— 最新实现状态

0）入口架构：优惠中心 (Discount Center)
   代码模块：`modules/discountCenter.js`
   UI 结构：
   [优惠中心]
    ├── [次卡] (Category)
    │    ├── [购买次卡] (Action: Purchase)
    │    └── [核销次卡] (Action: Redeem)
    └── [其他优惠] (预留)

1）售卡流程（VR：购买次卡）
   • 状态：✅ 代码完备 / 测试通过
   • 逻辑：
     - 购物车校验：纯净单。
     - 叠加购买：`create_pass_records` 自动判断 INSERT 或 UPDATE。
     - 结果：生成 `topup_orders` (VR)。

2）用卡核销流程（使用次卡结账）
   • 状态：✅ 已完成
   • 原阻碍：order_id NOT NULL 导致 0 元核销失败；
   • 现状：已通过迁移脚本修复，并完成 0 元 / 有加价两种场景实测。

【B1 注意事项：首购 vs 叠加购买的审核行为】

- 首购（首次为某会员+方案创建 member_passes 记录）：
  - 遵守 pass_plans.auto_activate 配置：
    - auto_activate = 1 → 直接 active，可立即核销；
    - auto_activate = 0 → 插入为 suspended，需总部审核通过后才能使用。

- 叠加购买（针对已有 member_passes 的次数追加）：
  - B1 阶段不变更 status，保持原有状态（通常为 active）。
  - 原因：避免因一次新叠加操作，将已有剩余次数全部锁死。
  - 后续若要对叠加购买也引入“审核后生效”机制，需要单独开 mini 阶段设计与落地（不能直接在 B1 静默改逻辑）。

- 核销：
  - POS 只对 status = 'active' 的卡执行核销。
  - suspended 在 B1 中统一视为“不可使用”，包含“待审核”和“业务冻结”等语义。

【B1 · 次卡状态 & 审核规则补充说明】
1.member_passes.status 的约定
oactive：卡片可用，可被 PoS 核销。
osuspended：卡片暂不可用，当前阶段用于两种情况：
1）新购卡且 pass_plans.auto_activate=0，等待总部审核；
2）人工挂起（包括运营、风控等原因）。
orevoked：卡片被彻底撤销，不可再使用。
oexpired：卡片已过期。
2.auto_activate 的行为
o auto_activate=1：
PoS 售卡后立即写入 status='active'，无需人工审核。
oauto_activate=0：
PoS 售卡时写入 status='suspended'，必须经 CPSYS 审核（Topup order review）后，才由 activate_member_pass() 切换为 active。
o 叠加购买（同一张卡追加次数）：
不再根据 auto_activate 改 status，延用原状态。
避免“已在使用的卡因为追加购买而被整体锁死”。
3.次卡核销支付白名单（加价场景）
o 术语：
0 元核销：仅消耗次卡次数，final_total/extra_total = 0。
有加价核销：存在 extra_total > 0，对应实际收款。
o 规则：
0 元核销：
当前阶段继续走“支付弹窗 + 0 元支付”，不做支付渠道限制（B1 决策）。
有加价核销：
前端仅展示「现金 / 银行卡」支付方式。
后端强制校验：只要发现第三方支付（Bizum/Platform 等）金额 > 0，则拒绝本次核销。
o 后续规划：
0 元核销流程会在后续阶段优化为「点击一次【核销】按钮 + 确认弹窗」，不再依赖支付弹窗。


三、当前代码库进度详解 (Audit Results)

1）P0 售卡：✅ Done
   - 修复了 1062 错误，修复了 500 依赖错误。

2）P1 会话：✅ Done
   - 白名单过滤正常。

3）P2 计价：✅ Done
   - 前后端计价逻辑一致。

4）P3 落库：🔴 Blocked
   - 代码逻辑已正确处理 `null` 写入，但 DB 结构未更新。

5）P4 打印：🟡 Pending Config
   - 代码已返回打印任务，需在 DB 配置模板。

四、下一步紧急任务 (Action Items)

1. [DB Migration] 修复 Schema (最高优先级)
   请立即在浏览器访问或通过命令行运行：
   `/pos/api/migrate_pass_redemptions_v2.php`
   以修改 `pass_redemption_batches` 和 `pass_redemptions` 表结构。

2. [Template Config] 配置打印模板
   执行 SQL 插入次卡核销凭条模板：
   ```sql
   INSERT INTO pos_print_templates (template_type, template_content, is_active) 
   VALUES ('PASS_REDEMPTION_SLIP', '{"type":"PASS_REDEMPTION_SLIP", "content":[...]}', 1);

3.[Retest] 回归测试
   - 场景：0 元核销。
   - 预期：成功落库，无报错，生成 VR 凭条打印任务。
   - 不报错。
   - pass_redemption_batches 记录成功写入。
   - pos_invoices 表中不生成新记录。

五、通用注意事项
   - 严禁手动修改 pos_pass_helper.php 中的逻辑，当前逻辑已高度完善。
   - 任何涉及时间的修改，必须使用 utc_now() 和 UTC 时区。