TopTea 次卡 · 大线总览（v1）

一、文档用途
本文件用于统一描述「TopTea 次卡」项目在各系统（POS / CPSYS / KDS / BMS）上的大线与阶段拆分，并给出每条大线当前状态和对应代码分支。
详细业务设计请参考：
- 《2.4《UTC统一+ 会员_次卡体系》_进度更新版.txt》
- 《总对齐文档（POS 视角版）_v2.txt》

本文件回答的问题是：
- 我们当前有哪些大线？
- 每条大线分成哪些阶段？
- 当前走到哪一步了？对应代码分支是什么？
- 阶段报告应该挂到哪里？

--------------------------------------------------
二、跨系统大线总览（按范围划分）

L1：统一模型与基础能力
- 系统范围：所有系统（POS / CPSYS / KDS / BMS）
- 目标：统一 UTC 时间处理、会员体系、次卡基本模型及关键字段定义。
- 主要依据文档：《2.4《UTC统一+ 会员_次卡体系》_进度更新版.txt》
- 当前状态：已完成第一轮设计与对齐，后续以增量维护为主。

L2：POS 线 – 次卡前台闭环（P0~P4）
- 系统范围：POS（前台收银）
- 目标：在现有 POS 上实现次卡购买、核销、结账落库、打印凭条的完整闭环。
- 子阶段（P0~P4）在下一节展开。
- 当前状态：
  - P0~P3：已完成并通过审计。
  - P4：代码与模板已实现，实机打印待验证。

补充 Mini 阶段：POS-CPSYS-PASS-VR-PRICE-MINI
- 范围：POS + CPSYS（售卡 VR 链路）
- 目标：审计并修复“次卡售价 From CPSYS 配置 → POS 展示 → VR 落库”的价格一致性问题。
- 当前状态：审计已完成（Gemini + Jules 报告），修复子阶段待 Claude 执行。

L3：总部 / CPSYS / BMS – 审核与报表
- 系统范围：总部系统（CPSYS / BMS）
- 目标：
  - 支持对次卡相关操作的审核（包括 0 元核销、order_id 为空的记录等）；
  - 支持总部维度的报表与对账（次卡余额、核销次数、收入拆分）。
- 当前状态：规划中，待在 POS 线稳定后启动。

L4：老线清理 – 旧表 / 旧函数 / 旧接口
- 系统范围：所有系统
- 目标：
  - 识别次卡旧方案残留的数据库表、旧函数、旧接口；
  - 给出“保留 / 迁移 / 清理”的规划。
- 拆分为两个步骤：
  - 2A：Schema 粗筛（按表结构和命名初步分类）。
  - 2B：代码引用审计（POS/KDS/CPSYS 三个代码库逐一检查实际使用情况）。
- 当前状态：
  - L4-2A（Schema 粗筛）：✅ 已完成（已有阶段报告 L4_2A_老线表_Schema粗筛_阶段报告_20251121.txt）；
  - L4-2B-POS（POS 代码引用审计）：✅ 已完成（已有阶段报告 L4_2B_POS_代码引用审计_阶段报告_20251121.txt）；
  - POS-EOD-MINI（幽灵函数熔断）：✅ 已完成（阶段报告 POS_EOD_幽灵函数熔断_mini阶段报告_20251121.txt）；
  - L4-2B-CPSYS（总部代码引用审计）：✅ 已完成，待挂阶段报告；
  - L4-2B-KDS（KDS 代码引用审计）：⏳ 待执行（计划方式与 POS/CPSYS 相同）。

--------------------------------------------------
三、POS 线 P0~P4 概览（L2 细化）

本节只描述 POS 项目内部的分阶段。详细行为和约束以《总对齐文档（POS 视角版）_v2.txt》为准。

P0：入口与现状梳理
- 目标：
  - 找到 POS 上次卡相关的入口（购卡入口、核销入口）；
  - 梳理当前代码结构和模块依赖。
- 状态：已完成。

P1：购卡流程（售卡）
- 目标：
  - 在 POS 前台完成次卡的购买流程；
  - 正确写入新模型（member_passes / topup_orders 等）。
- 状态：已完成（功能 + 审计）。

P2：核销入口与交互
- 目标：
  - 在 POS 前台实现“优惠中心 / 次卡核销”的入口和交互；
  - 确保操作员容易理解和使用。
- 状态：已完成。

P3：结账与落库（并发 + 幂等）
- 目标：
  - 核销时支持并发安全与幂等性（idempotency_key + FOR UPDATE）；
  - 支持 0 元核销（允许 order_id 为空，不生成 TP 发票）；
  - 确保 pass_redemptions / member_passes 等表结构与逻辑一致。
- 状态：
  - 已完成两轮审计（代码 + 数据库 + 实测案例），结论为“已达成设计要求”。

P4：打印模板与后台设置
- 目标：
  - 为次卡核销实现独立打印模板（PASS_REDEMPTION_SLIP）；
  - 确保 print_jobs 正确生成，pos_print_templates 中有对应 JSON 模板；
  - 在无打印机时先完成代码级自测，打印机到货后完成实机验证。
- 状态：
  - 模板设计与 SQL 已完成；
  - 已有 test_pass_redemption_slip.php 用于结构自测；
  - 实机打印验证待门店设备到位后进行。

--------------------------------------------------
四、阶段报告索引（待填充）

说明：
- 每当一个阶段（如 P3 / P4 / L4-2A）完成时，都会生成一份“阶段报告”。
- 阶段报告文件名建议格式：
  - POS_P3_结账与落库_阶段报告_YYYYMMDD.txt
  - POS_P4_打印模板_阶段报告_YYYYMMDD.txt
  - L4_2A_老线表_Schema粗筛_阶段报告_YYYYMMDD.txt

本节用于记录这些报告的文件名与简要摘要。

- L4_2A_老线表_Schema粗筛_阶段报告_20251121.txt
  - 内容：基于 db_schema_structure_only.sql 的 Schema 粗筛，确认当前快照中仅存在新线次卡表与其支撑表，未发现典型旧线次卡表；建议进入 L4-2B 进行代码引用审计。

- L4_2B_POS_代码引用审计_阶段报告_20251121.txt
  - 内容：审计 POS 代码中的所有表引用；确认次卡逻辑完全使用新线表；发现一个引用不存在表的死函数（calculate_eod_totals）以及个人券功能缺口，已登记为技术债。

- POS_EOD_幽灵函数熔断_mini阶段报告_20251121.txt
  - 内容：废弃 calculate_eod_totals，移除对幽灵表 pos_invoice_payments 的访问，保证现行 EOD 链路不受影响。

- POS-CPSYS-PASS-VR-PRICE-MINI_阶段报告_20251121.txt
  - 内容：次卡售价链路专项审计 + 修复（CPSYS → POS → VR）：
    - 售价唯一真相字段：pass_plans.sale_price；
    - 已修复 CPSYS handle_pass_plan_save 漏写 sale_price 问题；
    - 已提供并验证 fix_pass_plans_sale_price.php 数据回填脚本；
    - 已在测试环境 + POS 前端实测，确认 CPSYS 配置价 = POS 展示价 = VR 订单金额。  
  - 当前状态：✅ 审计 + 修复已完成（待生产 Data Patch 最终确认）。


示例（占位）：

- POS_P3_结账与落库_阶段报告_20251120.txt
  - 内容：并发与幂等实现、0元核销审计、自测结果、已知问题。

- POS_P4_打印模板_阶段报告_20251121.txt
  - 内容：PASS_REDEMPTION_SLIP 模板设计与自测、打印链路分析、已知问题与待实机验证事项。

--------------------------------------------------
五、使用说明

1. 当我们讨论“这条工作算不算完成”时，以本文件中的阶段定义与阶段报告为准。
2. 当我们开新分支时，应在本文件中记录该分支对应的是哪一个阶段或大线。
3. 当出现跨系统改动时（例如 POS 与 CPSYS 同时改），应在本文件中增加或更新对应大线的说明。

六、次卡 0 元核销交互优化（ISSUE-POS-PASS-UX-REDEEM-0PAY-001，预计在 POS-PASS-UX-REDEEM-ZERO-MINI 阶段处理）。