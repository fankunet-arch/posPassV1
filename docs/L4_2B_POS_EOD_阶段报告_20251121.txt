TopTea · L4-2B-POS-EOD-MINI 阶段报告
版本：v1.0
日期：2025-11-21
角色：TopTea 高级代码审计工程师（POS 线 · 班次/EOD 模块）

一、阶段背景与目标

本阶段是 L4-2B 的一个子阶段，聚焦 POS 端的「班次（Shift） / 日结（EOD） / 销售统计」链路。

目标：
1）梳理从 POS 班次开始 → 班次结束 → 日结提交的完整数据链路；
2）确认 ISSUE-POS-DB-001 相关的“幽灵表/幽灵代码”现状；
3）在不改数据库结构的前提下，给出一份「最小改动」的 EOD 修复设计，为后续开发（Claude/Jules）提供 TODO 列表。

二、现状梳理：POS 班次 & 日结/EOD 链路

1. 关键数据表职责

经对 pos_registry_ops_shift.php、pos_registry_ops_eod.php、pos_repo.php 与 db_schema_structure_only.sql 的交叉审计，当前职责如下：

- pos_invoices（核心 · 交易 SSOT）
  - 含义：所有销售/退款/税务合规数据的单一真实来源（Single Source of Truth）。
  - 用途：EOD 汇总、班次汇总均基于本表实时聚合。

- pos_shifts（核心 · 班次生命周期）
  - 含义：记录开班/关班、备用金、实点现金等信息。
  - 问题：正常关班流程下，expected_cash / cash_variance / payment_summary 字段 **未写入**，只有「强制关班」会填充，行为不一致。

- pos_eod_records（核心 · 班次快照）
  - 含义：在正常关班或强制关班时，记录该班次的销售汇总（以 shift 为维度）。
  - 说明：更像是 pos_shifts 的财务附表。

- pos_eod_reports（核心 · 日结存档）
  - 含义：在日结提交（handle_eod_submit_report）时，以“门店 + 日期”为维度生成全日财务快照。
  - 特点：一次日结可包含多个班次的数据，幂等控制防止重复提交。

- “幽灵表”类别（在旧代码里被提过、但 Schema 中并不存在）：
  - pos_invoice_payments
  - pos_orders
  - pos_cash_movements
  - 审计结果：这些表在当前 Schema 中不存在，老逻辑已经迁移走，属于历史残留名词。

2. 班次生命周期

- 开班（Shift Start）
  - 入口：pos_registry_ops_shift.php::handle_shift_start
  - 行为：INSERT pos_shifts，status='ACTIVE'，记录 store_id、user_id、starting_float。

- 正常关班（Shift End）
  - 入口：handle_shift_end
  - 行为：
    - 调用 pos_repo.php::compute_expected_cash() 计算理论现金、差异等；
    - 更新 pos_shifts：status='ENDED'、counted_cash=实点现金；
    - 插入 pos_eod_records：固化当前班次的销售汇总。
  - 问题点：
    - expected_cash / cash_variance / payment_summary 没有回写到 pos_shifts，导致 pos_shifts 本身信息不完整。

- 强制关班（Force Start / Close）
  - 入口：handle_shift_force_start
  - 行为：
    - 除了插入 pos_eod_records 外，还会写 pos_shifts.expected_cash / cash_variance / payment_summary。
  - 结果：
    - 正常关班与强制关班写 pos_shifts 的字段不一致，带来数据理解上的混乱。

3. EOD（日结）生成链路

- 聚合来源：
  - 唯一来源：pos_invoices。
  - 核心函数：pos_repo.php::getInvoiceSummaryForPeriod($start_utc, $end_utc)。
  - 内容：SUM(final_total)、SUM(taxable_base) 以及解析每条发票上的 payment_summary JSON，计算各支付方式总额。

- 写入逻辑：
  - 入口：pos_registry_ops_eod.php::handle_eod_submit_report
  - 行为：
    - 计算当日（或设定营业日范围）的销售汇总；
    - INSERT 到 pos_eod_reports，并设置门店 + 日期的幂等约束。

- 与 0 元次卡核销的关系：
  - 0 元核销不产生 pos_invoices 记录（无 TP 发票），因此不会进入 EOD 的财务口径；
  - 审计结论：EOD 是“财务日报”，0 元核销无资金变动，不统计在内是合理的；
  - 若需“出杯数”维度，应基于 pass_redemption_batches 等表单独设计。

三、ISSUE-POS-DB-001 及相关问题分析

1. ISSUE-POS-DB-001 源头

- 技术债文档原描述：calculate_eod_totals 函数引用了不存在的 pos_invoice_payments 表，可能导致 EOD 统计错误。

2. 实证结果

- 在 store_html/pos_backend/helpers/pos_helper.php 中存在 calculate_eod_totals()。
- 现状态：函数体已改为直接抛出 Exception("DEPRECATED: ...")，即：
  - 已“熔断”，任何调用都会立即爆炸。
- 核心链路（handle_shift_end / handle_eod_submit_report）均已切换到 pos_repo.php::getInvoiceSummaryForPeriod，不再调用该函数。

结论：
- 该 Issue 当前属于“幽灵代码，已熔断、待清理”；
- 不再影响生产数据，只是增加代码噪音与维护成本。

3. 数据一致性与可用性风险

- 风险 1：pos_shifts 数据不完整
  - 正常关班不写 expected_cash / cash_variance / payment_summary；
  - 强制关班会写，导致报表若直接看 pos_shifts 时信息参差不齐。

- 风险 2：支付方式扩展性差
  - getInvoiceSummaryForPeriod 内部对支付方式（Cash/Card/Platform）解析逻辑为 PHP 硬编码；
  - 新增支付方式（如单独统计 Bizum）需要改 PHP，而不是配置化。

四、“最小改动”修复设计（不改 Schema）

设计原则：
- 不新增表、不删表、不改字段类型；
- 收拢逻辑路径，让 pos_invoices / pos_eod_records / pos_eod_reports 成为 EOD 体系的三层 SSOT。

1. SSOT 定位

- 交易 SSOT：pos_invoices
- 班次快照 SSOT：pos_eod_records
- 日结快照 SSOT：pos_eod_reports

班次与日结的所有统计，都应明确基于以上三个层级构建。

2. 具体设计方案

（1）彻底移除幽灵函数 calculate_eod_totals

- 文件：store_html/pos_backend/helpers/pos_helper.php
- 行为：删除 calculate_eod_totals 函数定义（包括内部 Exception）；
- 要求：全局 grep，确认无任何调用再删除。

（2）统一正常关班与强制关班行为

- 文件：store_html/html/pos/api/registries/pos_registry_ops_shift.php
- 目标：
  - handle_shift_end 更新 pos_shifts 时，同时写入：
    - expected_cash
    - cash_variance
    - payment_summary
  - 使之与 handle_shift_force_start 在数据结构上保持一致。
- 数据来源建议：
  - 可直接复用 pos_repo.php::getInvoiceSummaryForPeriod 获取包含 payment_summary breakdown 的结构；
  - 或让 compute_expected_cash 返回一个包含支付分解的 totals 数组（由实现工程师选择）。

（3）明确 0 元核销在 EOD 中“忽略”的策略

- 不做 Schema 改动，不尝试在 EOD 中硬塞 0 元核销；
- 在系统说明中明确：
  - EOD 报表口径 = 有发票（pos_invoices）的财务流水；
  - 0 元核销属于“出杯统计”，将由 pass_redemption_batches 等表单独处理，不与 EOD 混用。

五、后续开发 TODO 列表（给 Claude/Jules 用）

以下任务可作为后续开发阶段的实现清单：

任务 1：清理幽灵函数（ISSUE-POS-DB-001 收尾）
- 文件：store_html/pos_backend/helpers/pos_helper.php
- 行为：删掉 calculate_eod_totals 函数及相关死代码。
- 验证：grep -r "calculate_eod_totals" 确认无引用。

任务 2：补全正常关班写入字段
- 文件：store_html/html/pos/api/registries/pos_registry_ops_shift.php
- 函数：handle_shift_end
- 行为：
  - 在更新 pos_shifts 时，加上 expected_cash / cash_variance / payment_summary 字段；
  - 数据从 getInvoiceSummaryForPeriod（推荐）或 compute_expected_cash 的返回结构中获取。

任务 3：核对并对齐强制关班逻辑
- 文件：同上
- 函数：handle_shift_force_start
- 行为：
  - 确认其写 pos_eod_records / pos_shifts 的字段与 handle_shift_end 一致；
  - 特别是现金差异（cash_diff / cash_variance）的计算公式需要统一。

任务 4：（可选）脏数据检查脚本
- 目标：检查现有 pos_shifts 表中 status='ENDED' 但 expected_cash 为空的记录，为后续是否要做数据回填提供参考。
- 形式：一个仅 SELECT 的 SQL 或简单工具脚本，不直接修改数据。

六、阶段结论

1）POS 的 EOD 主链路（基于 pos_invoices 的实时聚合）是健康且清晰的。  
2）ISSUE-POS-DB-001 涉及的核心风险已经通过“熔断旧函数 + 使用新聚合函数”规避，当前主要工作是代码清理。  
3）真正需要修复的是：班次结束时 pos_shifts 字段写入不完整，导致后续报表/分析使用该表时信息缺失。  
4）通过本阶段的“最小改动设计”，后续开发可以在不动 Schema 的前提下，收拢 EOD 链路，并消除遗留地雷。

（完）
