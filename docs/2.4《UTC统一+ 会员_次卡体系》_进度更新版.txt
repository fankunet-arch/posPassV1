2.4《UTC 统一 + 会员 _ 次卡体系》_V2
更新日期：2025-11-20
状态：开发冲刺与修复阶段

一、进度标记总览（已完成 / 🔴 阻碍中 / 🟡 待收尾）

0）全局基线 & 数据模型（所有线共用）
0) 背景与统一基线（UTC + DATETIME(6)）
   状态：✅ 已完成
   说明：
   - 数据库时间统一为 UTC + DATETIME(6)。
   - 连接层已强制 SET time_zone = '+00:00'。
   - 代码审计确认：所有涉及时间的 PHP helper (pos_datetime_helper.php) 均已强制使用 UTC。

1) 数据模型（pass_ / topup_orders / pos_tags 等）
   状态：🔴 需要修正 (Critical Schema Change)
   说明：
   - 核心表结构已建立。
   - [紧急修正] 发现 `pass_redemption_batches` 和 `pass_redemptions` 表的 `order_id` 字段约束过严 (NOT NULL)。
   - 导致问题：0 元核销（纯扣次、无加价）时，不生成 TP 发票 (order_id 为 null)，触发 SQL 1048 错误。
   - 修复任务：必须执行 ALTER TABLE 将 `order_id` 修改为允许 NULL。

2) 全局业务原则
   状态：✅ 代码已落实
   说明：
   - 一单一卡、不混单：已在 pos_pass_helper.php 中校验。
   - 限次规则：get_member_pass_for_update 已包含行锁和每日限次检查。
   - 幂等性：pass_redemption_batches 表已包含 idempotency_key 唯一索引，代码已实现查重逻辑。

3.1 CPSYS-RMS（主数据中心 · 仅主数据与只读）
R1/R2：主数据模型与后台 CRUD
   状态：✅ 已完成
   说明：
   - 单位/物料/产品/配方/标签（含 pass_eligible_beverage）均已建模。
   - POS 端已能通过 API 读取白名单标签。

3.2 CPSYS-BMS（总部经营 · 次卡后台与看板）
B1：次卡后台（只读/审核）
   状态：⚠️ 待确认 (高风险)
   说明：
   - 上一版本报告指出 `handle_topup_order_review()` 在拒绝审核 (Reject) 时存在 SQL 截断错误。
   - 本次代码包未包含后台代码，假设此问题仍待修复。
   - 任务：修复 cpsys_registry_bms.php。

B2：指标看板
   状态：🟡 部分完成
   说明：需确认看板 SQL 是否正确处理了 UTC -> 本地时间的转换。

3.3 POS 线（门店交易 · 核心战场）
   （注：POS 端代码已由资深工程师审计，逻辑完整度极高）

售卡流程（VR）
   状态：✅ 已完成
   说明：
   - 叠加购买：代码已实现“先查后写”，同一会员购买同一方案时执行 UPDATE 累加次数，彻底解决了 1062 唯一键冲突。
   - VR 单号：topup_orders 生成独立记录，单号分配正常。

P1：次卡会话与商品选择
   状态：✅ 已完成
   说明：
   - 前端已支持进入/退出核销模式。
   - 白名单过滤生效，非次卡商品自动隐藏。

P2：加料与上限规则
   状态：✅ 已完成
   说明：
   - 服务端 `calculate_redeem_allocation` 函数已修复（无截断）。
   - 逻辑：准确计算 global_free_addon_limit（免费加料上限），超出部分正确计入 extra_charge_total。

P3：结账与落库（并发与幂等）
   状态：🔴 阻碍中 (Blocking)
   说明：
   - 代码逻辑：`create_redeem_records` 事务逻辑完整，包含了发票分流（有加价开 TP，无加价不开）。
   - 阻碍点：进行 0 元核销测试时，因数据库 `order_id` 不允许为空，导致写入失败。
   - 解决：等待数据库 Schema 修正后即可通过。

P4：打印模板与后台设置
   状态：🟡 待配置
   说明：
   - 代码层：后端已构建完整的打印数据包 (`print_jobs`)，包含剩余次数、核销时间等。
   - 配置层：数据库 `pos_print_templates` 表中缺失 `PASS_REDEMPTION_SLIP` 的模板数据，导致前端可能无法出纸。

二、给工程师的最新任务清单 (V2)

A. 数据库修复 (最高优先级 · 立即执行)
   目标：解决 0 元核销报错 SQLSTATE[23000]: 1048
   SQL：
   ALTER TABLE `pass_redemption_batches` MODIFY COLUMN `order_id` INT UNSIGNED NULL COMMENT '关联 pos_invoices.id (TP), 0元核销时为NULL';
   ALTER TABLE `pass_redemptions` MODIFY COLUMN `order_id` INT UNSIGNED NULL COMMENT '关联 pos_invoices.id (TP), 0元核销时为NULL';

B. 打印配置 (高优先级)
   目标：让 POS 能打出核销凭条
   动作：编写 SQL 脚本，向 `pos_print_templates` 插入 `template_type = 'PASS_REDEMPTION_SLIP'` 的标准 JSON 模板。

C. BMS 后台修复 (中优先级)
   目标：确保后台审核功能可用
   动作：修复 `cpsys_registry_bms.php` 中审核拒绝逻辑的 SQL 语法错误。

D. 全链路回归 (执行完 A/B 后)
   1. 购卡 (VR) -> 成功。
   2. 核销 (0元) -> 成功落库，无 TP 发票，打印 VR 凭条。
   3. 核销 (含加价) -> 成功落库，生成 TP 发票，打印 TP 发票。