# TopTea 次卡 · POS 技术债与 Issue 清单（v2）
更新日期：2025-11-21

说明：
- 本文只记录「POS 线」与次卡相关的已知问题与技术债。
- 作用：给未来的阶段任务提供“问题池”，避免重复排查同一件事。
- 状态枚举：`OPEN`（未动）、`IN_PROGRESS`、`DONE`（已完成）、`DEFERRED`（延期到未来阶段）。

---

## 1. 打印相关问题

### ISSUE-POS-PRINT-001：打印模板字段命名不统一
- 类型：一致性 / 可维护性
- 模块：打印（小票 / 杯贴 / PASS 核销单）
- 描述：
  - 部分老模板使用 `{item_name}`，新模板使用 `{title}`, `{variant_name}`, `{qty}`。
  - 易造成新模板照抄旧字段名，渲染为空。
- 影响：
  - 当前 PASS_REDEMPTION_SLIP 模板已采用新字段，短期不阻塞上线。
- 临时措施：
  - 本次项目中所有新模板统一使用 `{title}` 等新字段。
- 计划修复阶段：
  - PRINT 规范化阶段（未来单独的大线）。
- 当前状态：`OPEN`（记录中）。

---

## 2. 次卡业务与支付相关

### ISSUE-POS-PASS-REVIEW-001：次卡售卡审核链路未生效（已修复）
- 类型：业务逻辑缺失（CPSYS-B1 ↔ POS-PASS）
- 描述（旧）：
  - 无论 pass_plans.auto_activate 如何配置，member_passes 一律插入 status='active'。
- 现状：
  - create_pass_records 现已根据 auto_activate 决定初始 status：
    - auto_activate=1 → active
    - auto_activate=0 → suspended（待审核）
  - POS 核销只接受 status='active'。
- 相关文档：
  - 《CPSYS-B1-PASS-REVIEW-AND-PAYMENT-MINI_阶段完成报告》
- 当前状态：`DONE`.

### ISSUE-POS-PASS-PAYMENT-001：核销加价场景支付方式无限制（已修复）
- 类型：支付安全
- 描述（旧）：
  - extra_charge_total > 0 时，前端展示所有支付方式，后端不做限制。
- 现状：
  - 前端 payment.js：
    - isPassRedemptionWithCharge 时仅展示「现金 / 银行卡」等白名单方式。
  - 后端 handle_pass_redeem：
    - extra_total > 0 且选择平台支付 → 直接报错拒绝。
- 当前状态：`DONE`.

### ISSUE-POS-PASS-PRICE-001：POS 端未完全以 pass_plans.sale_price 为唯一真相
- 类型：数据一致性
- 描述：
  - 历史分支中存在从本地配置/常量读取价格的可能性。
- 现状：
  - PASS-VR-PRICE-MINI 阶段已明确 sale_price 为唯一真相。
  - 部分代码路径仍需人工复查（特别是老界面和测试脚本）。
- 当前状态：`IN_PROGRESS`（等待彻底清点与清理）。

### ISSUE-POS-I18N-001：次卡名称多语言（I18N）显示不一致
- 类型：界面国际化
- 描述：
  - 某些界面使用 name_zh，某些使用 name_es，未统一通过 I18N 层或统一字段。
- 现状：
  - PASS 相关主界面已修复，售卡与核销流程中使用正确的多语言字段。
- 当前状态：`DONE`（核心路径已修复，局部老界面可后续一起清理）。

---

## 3. EOD / 班次相关技术债

### ISSUE-POS-DB-001：EOD 幽灵表 / 幽灵函数（已熔断）
- 类型：架构遗留
- 描述（旧）：
  - pos_helper::calculate_eod_totals 调用幽灵表 pos_invoice_payments，若被误用会导致 SQL 500。
- 现状：
  - 该函数已被熔断：进入即 throw Exception("DEPRECATED...")。
  - 正式 EOD 链路全部走 pos_repo::getInvoiceSummaryForPeriod()。
- 当前状态：`DONE`（熔断完成，未来可考虑彻底删除死代码）。

### ISSUE-POS-EOD-001：正常关班未写入 expected_cash / cash_variance / payment_summary（已修复）
- 类型：数据不完整
- 描述（旧）：
  - 正常关班只写 end_time / status / counted_cash，导致对账数据不全。
- 现状：
  - handle_shift_end 已补齐：
    - 计算 expected_cash / cash_variance；
    - 用 getInvoiceSummaryForPeriod 构建 payment_summary（cash/card/platform/total）；
    - 写入 pos_shifts 全部字段。
- 当前状态：`DONE`.

### ISSUE-POS-EOD-002：强制关班 payment_summary 信息不完整（增强项）
- 类型：数据丰富度 / 分析便利性
- 描述（旧）：
  - FORCE_CLOSED 的 payment_summary 仅包含 note（谁强制关），无金额分解。
- 现状：
  - 已按建议补齐：和正常关班共用现金/银行卡/平台分解，并保留 note。
- 当前状态：`DONE`（视作增强项已完成）。

---

## 4. 目录与代码结构相关

### ISSUE-POS-DIR-001：嵌套目录 html/pos/pos/（已清理）
- 类型：幽灵目录 / 冗余代码
- 描述：
  - store_html/html/pos/pos/ 是一个对 pos 目录的递归拷贝，易引起“改错地方”的问题。
- 现状：
  - 已通过内容哈希比对与版本审计，确认主线在 store_html/html/pos/。
  - ghost 目录 html/pos/pos/ 已移除。
- 当前状态：`DONE`.

---

（其余低优先级小问题，可在未来需要时从 v1 版本的技术债文档中再“翻老账”，本 v2 只保留对次卡与 EOD 大线影响最大的条目。）
