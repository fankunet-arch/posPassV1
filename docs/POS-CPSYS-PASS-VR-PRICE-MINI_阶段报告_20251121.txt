POS-CPSYS-PASS-VR-PRICE-MINI 阶段报告（2025-11-21）

一、基本信息
- 阶段ID：POS-CPSYS-PASS-VR-PRICE-MINI
- 阶段名称：次卡售价链路专项审计（CPSYS → POS → VR）
- 系统范围：跨系统（CPSYS/BMS + POS）
- 时间范围：2025-11-21
- 相关 Issue：
  - ISSUE-POS-PASS-PRICE-001
  - ISSUE-CPSYS-PASS-PRICE-001
- 输入材料：
  - CPSYS 代码仓（/hq_html/html/cpsys）
  - POS 代码仓（/store_html/html/pos + /store_html/pos_backend）
  - db_schema_structure_only.sql
  - Gemini 审计报告 + Jules 审计报告

二、阶段目标回顾
1. 查清楚“次卡售价”从 CPSYS 配置到 POS 展示，再到 VR 订单落库的完整数据链路；
2. 确定售价的唯一真相字段（Source of Truth）；
3. 找出“方案显示 60€，POS / VR 变 0€”的根本原因；
4. 给出面向 Claude 的修复建议，为后续修复子阶段提供输入。

三、核心审计结论

1）售价唯一真相
- 唯一真相字段：pass_plans.sale_price (DECIMAL(10,2))
- 设计期望：
  - CPSYS：在编辑方案时维护 sale_price；
  - POS：优惠中心展示和售卡金额都以 sale_price 为准；
  - topup_orders.amount_total：应等于 sale_price * 数量。

2）CPSYS 侧问题（根因）
- 文件：/hq_html/html/cpsys/api/registries/cpsys_registry_bms_pass_plan.php
- 函数：handle_pass_plan_save
- 发现：
  - 后端接收了前端的 sale_settings['price']；
  - 仅用于更新 pos_item_variants.price_eur（影子商品价格）；
  - 在构建写入 pass_plans 的 SQL 时，完全遗漏了 sale_price 字段（INSERT/UPDATE 都未涉及）。
- 结果：
  - pass_plans.sale_price 长期保持 0.00，无论界面上配置多少。

3）POS 侧表现
- 列表接口 handle_pass_list 直接从 pass_plans.sale_price 读取价格返回前端；
- 前端展示为 0.00，并将 0 作为 cart_item.price 提交；
- create_pass_records() 使用 cart_item.price 写入 topup_orders.amount_total；
- 整条链路“诚实地”把 0 贯彻到底。

四、实际改动建议（供后续修复阶段使用）

1）CPSYS 写入修复（High Priority）
- 在 handle_pass_plan_save 中：
  - plan_params 中增加 :sale_price => (float)$sale_settings['price'];
  - 在 INSERT / UPDATE SQL 中增加 sale_price = :sale_price；
- 确保今后任何保存/修改方案操作都会同步更新 pass_plans.sale_price。

2）历史数据回填（Data Patch）
- 目的：把当前已经存在的方案价格从影子商品恢复到 pass_plans.sale_price。
- 建议做法：
  - 通过 sale_sku 关联 pos_menu_items 和 pos_item_variants；
  - 对 sale_price = 0 且 variant.price_eur > 0 的记录执行一次性 UPDATE。

3）POS 侧安全增强（Optional）
- 中长期建议：
  - 在 handle_pass_purchase 中，根据传入的 pass_plan_id 再查一次 pass_plans.sale_price；
  - 用数据库值覆盖前端价格，防止前端被篡改。

五、自测与验证建议

1）配置与保存
- 在 CPSYS 修改一个次卡方案价格为 60.00 并保存；
- 检查 pass_plans.sale_price 是否正确更新为 60.00。

2）POS 展示
- 刷新 POS 优惠中心页面；
- 确认该方案展示价格为 60.00€。

3）VR 落库
- 在 POS 发起一次真实/测试售卡；
- 检查 topup_orders 记录：
  - amount_total 是否为 60.00；
  - CPSYS Topup Orders 页面总金额是否一致。

六、阶段结论与后续建议

- 阶段结论：
  - 本 Mini 阶段的审计目标已完成：
    - 已明确售价唯一真相字段；
    - 已定位问题根因在 CPSYS handle_pass_plan_save；
    - 已给出针对 CPSYS 和 POS 的修复建议。
- 下一步建议：
  1）立项“POS-CPSYS-PASS-VR-PRICE-MINI · 修复子阶段”，由 Claude 在 CPSYS 仓执行代码修改 + Data Patch；
  2）修复完成后，再更新：
     - pos_known_issues_and_debts.md 中本 Issue 的状态为“已修复，待门店验证”；
     - cpsys_known_issues_and_debts.md 中 ISSUE-CPSYS-PASS-PRICE-001 的状态。

七、修复子阶段落地结果（2025-11-21 更新）

1）代码修复状态
- 已按本报告的建议，由 Claude 在 CPSYS 仓实现写入修复：
  - 文件：hq_html/html/cpsys/api/registries/cpsys_registry_bms_pass_plan.php
  - 动作：在 handle_pass_plan_save 中补齐 :sale_price 参数，并在 INSERT / UPDATE 语句中写入 pass_plans.sale_price。
- 同时保留了原有对 pos_item_variants.price_eur 的更新，确保两者价格同步。:contentReference[oaicite:8]{index=8}  

2）数据修复状态
- 新增工具脚本：hq_html/html/cpsys/tools/fix_pass_plans_sale_price.php
- 逻辑：针对 sale_price=0 且 variant.price_eur>0 的记录，从 pos_item_variants.price_eur 回填到 pass_plans.sale_price。
- 设计为幂等，可多次执行。:contentReference[oaicite:9]{index=9}  

3）测试与验证
- 已根据 TESTING_GUIDE_sale_price_fix.md 在测试环境完成整条链路测试：
  - CPSYS 修改方案售价 → pass_plans.sale_price 正确更新；
  - POS 优惠中心展示价格与配置一致；
  - POS 售卡后，topup_orders.amount_total 与配置价格一致；
  - CPSYS Topup Orders 列表金额正确展示。:contentReference[oaicite:10]{index=10}  
- 你已在 POS 前端实测确认价格显示正确。

4）阶段状态更新
- 原状态：仅完成审计，修复子阶段“待执行”；
- 当前状态：审计 + 修复 + 测试环境验证 已全部完成；
- 剩余任务：在生产环境按测试指南执行 Data Patch，并完成一轮线上验证。

至此，“POS-CPSYS-PASS-VR-PRICE-MINI” 阶段可以标记为：
- 状态：✅ Completed (Tested in staging / POS UI)，待生产验证。
