# POS 已知问题与技术债清单（TopTea 次卡相关）

说明：
- 本文仅记录 POS 线中的已知问题与技术债，方便后续阶段性集中处理。
- 每条问题包含：编号、类型、模块、描述、影响、临时措施、计划修复阶段与当前状态。
- 编号规则：`ISSUE-POS-<类别>-<序号>`，以及少量架构备注 `ARCH-POS-...`。

---

## 1. 打印相关问题

### ISSUE-POS-PRINT-001：打印模板中商品字段命名不统一

- 类型：一致性问题 / 潜在显示错误
- 模块：POS · 打印（小票 / 杯贴）
- 描述：
  - 杯贴（Cup Sticker）模板中使用占位符 `{item_name}` 表示商品名称；
  - 次卡核销小票（`PASS_REDEMPTION_SLIP`）模板中使用 `{title}` / `{variant_name}` / `{qty}`；
  - 不同模板中对“商品名称”的字段命名不统一，未来新增模板时容易误抄 `{item_name}`，导致渲染结果为空。
- 影响：
  - 当前版本中，`PASS_REDEMPTION_SLIP` 模板已确认使用 `{title}` 等字段，短期内不会影响生产；
  - 但模板设计缺乏统一规范，新模板或后续修改存在踩坑风险。
- 临时措施：
  - 本次次卡核销小票模板中，仅使用 `{title}`, `{variant_name}`, `{qty}` 不使用 `{item_name}`；
  - 在设计打印模板时，优先参考新线模板字段命名，不再沿用旧的 `{item_name}` 写法。
- 计划修复阶段：
  - 建议在后续“打印系统规范化阶段”（例如 P4.x 或专门的 PRINT 规范任务）统一：
    - 定义所有打印任务通用的字段命名规范；
    - 对现有模板字段进行一次体检（必要时重构）。
- 当前状态：记录中（未统一规范，仅局部规避）。

---

## 2. 数据库 / 日结（EOD）相关问题

### ISSUE-POS-DB-001：calculate_eod_totals 引用不存在的 `pos_invoice_payments` 表

- 类型：技术债 / 潜在运行时错误（幽灵表引用）
- 模块：POS · 后端 EOD（日结）辅助函数
- 位置（参考）：`pos_backend/helpers/pos_helper.php` 中的 `calculate_eod_totals` 函数
- 描述：
  - 函数 `calculate_eod_totals` 中原本存在 SQL，引用了表 `pos_invoice_payments`；
  - 在当前 Schema（`db_schema_structure_only.sql`）中，**不存在** `pos_invoice_payments` 这张表；
  - EOD 正式逻辑已经在 `pos_repo.php::getInvoiceSummaryForPeriod()` 中实现，基于 `pos_invoices.payment_summary` 字段；
  - `calculate_eod_totals` 确认属于旧实现残留的“幽灵函数”。

- 影响：
  - 修复前：若该函数被旧接口或未来误调用，会因访问幽灵表导致 SQL 错误（500）；
  - 容易误导后续维护者，以为系统存在 `pos_invoice_payments` 这张表。

- 修复方式（2025-11-21）：
  - 分支：`claude/secure-eod-module-01ACdts5h7P4fHesgdvk757r`
  - Commit：`c454508 - [SECURITY] Deprecate calculate_eod_totals`
  - 具体改动：
    - 保留 `calculate_eod_totals` 函数签名；
    - 在函数开头抛出明确的废弃异常（包含 "DEPRECATED" 关键字，并指向 `pos_repo::getInvoiceSummaryForPeriod()` 作为替代）；
    - 删除所有访问 `pos_invoice_payments` 的 SQL 逻辑；
    - 添加 `@deprecated` / `@throws` PHPDoc 注解和简短说明，方便后续维护者追踪。

- 自测要点：
  - 直接调用 `calculate_eod_totals(...)`：
    - 预期：抛出“DEPRECATED” 异常，而非 SQL 错误；
  - 通过 API 走一遍 EOD 流程：
    - `?res=eod&act=get_preview`、`?res=eod&act=submit_report` 返回 200，统计结果正常；
    - PHP 错误日志中不再出现 `pos_invoice_payments` 相关错误。

- 当前状态：
  - ✅ 已修复（2025-11-21），待门店/测试环境按上述自测方案验证；
  - 后续在全系统幽灵表整理报告中，将本案例列为“已处理示例”。

---

## 3. 功能缺口 / 优惠券相关问题

### ISSUE-POS-FEATURE-001：POS 不支持 `pos_member_issued_coupons`（个人券）核销

- 类型：功能缺口 / 业务能力未覆盖
- 模块：POS · 优惠券系统
- 描述：
  - 数据库 Schema 中存在 `pos_member_issued_coupons` 表，含义为“发放给某个具体会员的优惠券实例”；
  - POS 当前的优惠券处理逻辑，仅基于 `pos_coupons`（通用券/公开券），未实现对 `pos_member_issued_coupons` 的读取与核销；
  - 这意味着：“个人券”（只针对某个会员）在 POS 前端目前不可用。
- 影响：
  - 如业务希望使用“个人券”场景（例如针对部分会员的精准优惠），POS 端暂无法直接支持；
  - 当前次卡项目范围内不涉及个人券，因此不影响本阶段上线，但属于未来可扩展能力。
- 临时措施：
  - 业务侧如暂不规划个人券功能，则可以接受现状；
  - 若后续要启用个人券，需要专门立一个“优惠券系统增强”需求。
- 计划修复阶段：
  - 建议在“优惠券系统增强 / 精准营销”阶段统一规划：
    - POS 加入对 `pos_member_issued_coupons` 的支持；
    - 与 CPSYS/HQ 的发券逻辑打通。
- 当前状态：记录中（功能缺口，当前项目不处理）。

---

## 4. 架构备注：幽灵表与旧表的定义（重要）

### ARCH-POS-GHOST-TABLES-001：幽灵表与旧表的区分与审计策略

- 类型：架构级备注 / 审计方法说明
- 描述：
  - **幽灵表（Ghost Table）**：
    - 指代码中仍然引用，但在当前 Schema 中已经不存在的表；
    - 典型表现：某个函数/模块的 SQL 使用某表名，Schema 里没有该表定义；
    - 这类问题一旦执行，将直接造成运行时错误（500）。
    - 示例：`pos_invoice_payments` 就是当前已确认的幽灵表引用。
  - **旧表（Legacy Table）**：
    - 指数据库中仍存在，但已经不再被现有链路使用的表；
    - 注意：旧表**不一定以 `old_` 前缀命名**，很多旧表是按“新风格命名”保留下来的（例如早期版本的设计残留），只是升级链路时改用了新表而未删除旧表；
    - 旧表在短期内不会直接导致错误，但会让 Schema 与实际业务不一致，增加维护成本。
- 审计策略：
  - 幽灵表：
    - 通过“代码引用 vs 当前 Schema”对比，可以发现代码中使用但 Schema 中不存在的表名；
    - POS 线 L4-2B 已经找到一个典型案例（ISSUE-POS-DB-001），全系统（POS/KDS/CPSYS）完成 L4-2B 后，需要统一汇总所有幽灵表引用并逐一清理。
  - 旧表：
    - 不能仅依赖命名规则（例如 `old_` 前缀），因为历史上旧表也可能已经按新命名风格；
    - 需要结合：
      - Schema 粗筛（L4-2A）；
      - 各线代码引用审计（L4-2B）；
    - 得出“在 Schema 存在但各线代码均不再引用”的表清单，然后以“改名 / 降权 / 观察期 / 最终清理”的节奏处理。
- 当前状态：
  - POS 线 L4-2B：已发现一个幽灵表引用（ISSUE-POS-DB-001）；
  - 全系统幽灵表与旧表的最终清单，待 POS / CPSYS / KDS 各线 L4-2B 完成后统一整理。

## 5. 次卡售价与展示/落库不一致

### ISSUE-POS-PASS-PRICE-001：次卡方案售价 60€，POS 与 VR 订单金额为 0.00€

- 类型：跨系统逻辑不一致 / 严重业务错误
- 模块：POS · 次卡售卡（VR） / CPSYS · 次卡方案管理
- 描述：
  - 在 CPSYS 的「次卡方案管理」页面中，可以为每个方案配置“销售价格 (€)”；
  - 现象：
    - 方案页面中已设置售价，例如「10次奶茶卡」= 60.00€；
    - POS 优惠中心中同一张卡显示为 0.00€；
    - POS 结账时，应收金额为 0.00€；
    - CPSYS Topup Orders 页面中，对应 VR 订单的 “总金额 (€)” 也为 0.00€；
  - 说明：
    - 这表明当前售卡链路并未正确使用 pass_plans 中配置的售价字段，
      而是从其他来源（例如 POS 商品价格，或未初始化的字段）读取，导致 VR 订单金额为 0。

- 影响：
  - 实际售卡价格与总部配置不一致，造成收入确认错误；
  - VR 订单金额为 0，后续财务对账与税务处理存在严重偏差；
  - 很难在不查日志的情况下发现问题，属于“静默错误”。

- 初步推测（待代码审计确认）：
  - 可能仍在使用 POS 普通商品价格作为次卡售价，而 PASS 销售 SKU 对应商品价格为 0；
  - 或者 POS/后端代码读取的是旧字段（如 price），而 pass_plans 的新字段（如 sale_price）未被使用。

- 临时措施：
  - 暂不进行大规模售卡，避免产生更多 0 元 VR 订单；
  - 所有测试售卡订单仅用于联调，不计入真实业绩。

- 建议修复阶段：
  - 新增一个 Mini 阶段：`POS-CPSYS-PASS-VR-PRICE-MINI`：
    - 由 Gemini 对 CPSYS + POS 代码进行完整链路审计：
      - 明确“价格唯一真相”应来自哪个字段（建议：pass_plans 中的售价字段）；
      - 找出 POS/后端在构造 VR 订单与前端展示时使用的字段；
    - 由 Claude 在此基础上修复：
      - 统一 POS 展示价格、结账金额、topup_orders.amount_total 的来源；
      - 清理不再使用的旧字段/逻辑（需谨慎，不改 Schema）。

- 当前状态：已记录，等待专门 Mini 阶段立项与修复。

---
## 6. 多语言 / 文案显示问题

### ISSUE-POS-I18N-001：次卡名称在西班牙语界面下仍显示中文

- 类型：多语言/i18n 体验问题（需进一步确认是数据还是代码问题）
- 模块：POS · 次卡展示（优惠中心） / CPSYS · 次卡方案管理
- 描述：
  - 当前次卡方案仅录入了中文名称；
  - 在 POS 切换为西班牙语界面时，次卡名称仍显示中文；
  - 需确认：
    - CPSYS / DB 中是否存在西班牙语名称字段（如 name_es）但数据为空；
    - 或 POS 前端在多语言环境下始终读取中文字段（硬编码），没有做语言 fallback。

- 影响：
  - 西班牙语模式下，员工看到的仍是中文，不利于日常使用与培训；
  - 后续如果接入多语言小票/前台文案，会持续产生不一致。

- 建议修复阶段：
  - 与次卡售价问题一起，在 `POS-CPSYS-PASS-VR-PRICE-MINI` 或单独的 i18n 整理阶段中处理：
    - 审计 pass_plans / 相关表的多语言字段设计；
    - 明确 POS 在不同语言下的字段选择和回退策略；
    - 制定运营层面的文案录入规范（必须同时填写中/西文）。

- 当前状态：已记录，待确认是“缺数据”还是“代码逻辑问题”。
---
## 7. 审核机制与核销支付渠道限制

### ISSUE-POS-PASS-FLOW-002：次卡售卡缺少“需人工审核”配置，且核销加价支付渠道未受限

- 类型：业务流程缺口 / 风控规则未落地
- 模块：POS · 次卡售卡与核销结账 / CPSYS · 次卡方案管理（B1）
- 描述：
  1）审核机制缺失：
     - CPSYS 的 Topup Orders 页面中，次卡售卡订单状态为 `pending`；
     - 实际上，POS 已经可以立刻核销该次卡，说明当前实现是“自动激活 + 审核仅作展示”；
     - 2.4 文档中的 B1 阶段本来预期存在“售卡 VR 审核”流程（⚠️ 高风险），需要在方案层面
       提供“自动生效 / 需人工审核”的配置，并在核销时真正生效。

  2）核销支付渠道未受限：
     - 当次卡核销存在额外加价（extra_charge_total > 0）时，POS 结账弹窗会展示所有支付方式
       （现金 / 刷卡 / Bizum / 平台码等）；
     - 业务期望：次卡核销产生的加价部分，仅允许使用“现金 / 银行卡”支付，
       其他渠道在该场景下应被隐藏或禁止使用。

- 影响：
  - 审核缺失：
    - 无法对高风险或特殊次卡进行人工把关；
    - 后台看到大量 pending 订单，但对应卡已经在使用，审核记录形同虚设。
  - 支付渠道未限：
    - 财务与风控难以对“次卡相关收入”建立统一口径（例如要求全部走现金/刷卡）；
    - 某些支付方式可能不适合与次卡场景叠加，容易引起对账和合规问题。

- 建议修复阶段：
  - 新增一个阶段或子阶段：`CPSYS-B1-PASS-REVIEW-AND-PAYMENT`：
    - 设计层面：
      - 在 pass_plans 增加“是否需人工审核”配置；
      - 定义审核通过前，member_passes 不可核销的规则（可以是延迟创建 member_passes，或创建但标记为 pending）；
      - 为“次卡核销加价”增加支付渠道白名单配置（首版可写死为现金/银行卡）。
    - 实现层面（Claude 执行）：
      - 修改 POS 售卡与核销逻辑，接入上述配置；
      - 在结账层统一限制核销场景下的支付方式，并在后端做托底校验。

- 当前状态：已记录，等待与 B1 阶段需求统一规划后实施。
