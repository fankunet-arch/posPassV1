# POS 已知问题与技术债清单（TopTea 次卡相关）

说明：
- 本文仅记录 POS 线中的已知问题与技术债，方便后续阶段性集中处理。
- 每条问题包含：编号、类型、模块、描述、影响、临时措施、计划修复阶段与当前状态。
- 编号规则：`ISSUE-POS-<类别>-<序号>`，以及少量架构备注 `ARCH-POS-...`。

---

## 1. 打印相关问题

### ISSUE-POS-PRINT-001：打印模板中商品字段命名不统一

- 类型：一致性问题 / 潜在显示错误
- 模块：POS · 打印（小票 / 杯贴）
- 描述：
  - 杯贴（Cup Sticker）模板中使用占位符 `{item_name}` 表示商品名称；
  - 次卡核销小票（`PASS_REDEMPTION_SLIP`）模板中使用 `{title}` / `{variant_name}` / `{qty}`；
  - 不同模板中对“商品名称”的字段命名不统一，未来新增模板时容易误抄 `{item_name}`，导致渲染结果为空。
- 影响：
  - 当前版本中，`PASS_REDEMPTION_SLIP` 模板已确认使用 `{title}` 等字段，短期内不会影响生产；
  - 但模板设计缺乏统一规范，新模板或后续修改存在踩坑风险。
- 临时措施：
  - 本次次卡核销小票模板中，仅使用 `{title}`, `{variant_name}`, `{qty}` 不使用 `{item_name}`；
  - 在设计打印模板时，优先参考新线模板字段命名，不再沿用旧的 `{item_name}` 写法。
- 计划修复阶段：
  - 建议在后续“打印系统规范化阶段”（例如 P4.x 或专门的 PRINT 规范任务）统一：
    - 定义所有打印任务通用的字段命名规范；
    - 对现有模板字段进行一次体检（必要时重构）。
- 当前状态：记录中（未统一规范，仅局部规避）。

---

## 2. 数据库 / 日结（EOD）相关问题

### ISSUE-POS-DB-001：calculate_eod_totals 引用不存在的 `pos_invoice_payments` 表

- 类型：技术债 / 潜在运行时错误（幽灵表引用）
- 模块：POS · 后端 EOD（日结）辅助函数
- 位置（参考）：`pos_backend/helpers/pos_helper.php` 中的 `calculate_eod_totals` 函数
- 描述：
  - 函数 `calculate_eod_totals` 中存在 SQL，引用了表 `pos_invoice_payments`；
  - 在当前 Schema（`db_schema_structure_only.sql`）中，**不存在** `pos_invoice_payments` 这张表；
  - 实际的支付信息和日结逻辑，已基于 `pos_invoices.payment_summary` JSON 字段在 `pos_repo.php` 中实现；
  - `calculate_eod_totals` 疑似旧实现残留，目前应处于“死代码 / 幽灵函数”状态。
- 影响：
  - 如果该函数被旧接口或未来新代码误调用，将直接导致 500 错误（引用不存在的表）；
  - 对后续维护者存在误导：看代码会以为系统有 `pos_invoice_payments` 这张表。
- 临时措施：
  - 暂不在当前次卡阶段直接删除或重写该函数；
  - 将其标记为技术债，在日结模块整理时统一处理。
- 计划修复阶段：
  - 在专门的“EOD/日结模块整理”小版本中处理（计划单独开分支）：
    - 方案A：确认完全没有引用后，删除该函数或将其实现替换为统一调用 `pos_repo` 中的日结逻辑；
    - 方案B：如仍有合法调用路径，则重写函数，使其基于 `pos_invoices.payment_summary` 实现，彻底移除对幽灵表的引用。
- 当前状态：已确认问题存在，准备在近期 mini 任务中修复。

---

## 3. 功能缺口 / 优惠券相关问题

### ISSUE-POS-FEATURE-001：POS 不支持 `pos_member_issued_coupons`（个人券）核销

- 类型：功能缺口 / 业务能力未覆盖
- 模块：POS · 优惠券系统
- 描述：
  - 数据库 Schema 中存在 `pos_member_issued_coupons` 表，含义为“发放给某个具体会员的优惠券实例”；
  - POS 当前的优惠券处理逻辑，仅基于 `pos_coupons`（通用券/公开券），未实现对 `pos_member_issued_coupons` 的读取与核销；
  - 这意味着：“个人券”（只针对某个会员）在 POS 前端目前不可用。
- 影响：
  - 如业务希望使用“个人券”场景（例如针对部分会员的精准优惠），POS 端暂无法直接支持；
  - 当前次卡项目范围内不涉及个人券，因此不影响本阶段上线，但属于未来可扩展能力。
- 临时措施：
  - 业务侧如暂不规划个人券功能，则可以接受现状；
  - 若后续要启用个人券，需要专门立一个“优惠券系统增强”需求。
- 计划修复阶段：
  - 建议在“优惠券系统增强 / 精准营销”阶段统一规划：
    - POS 加入对 `pos_member_issued_coupons` 的支持；
    - 与 CPSYS/HQ 的发券逻辑打通。
- 当前状态：记录中（功能缺口，当前项目不处理）。

---

## 4. 架构备注：幽灵表与旧表的定义（重要）

### ARCH-POS-GHOST-TABLES-001：幽灵表与旧表的区分与审计策略

- 类型：架构级备注 / 审计方法说明
- 描述：
  - **幽灵表（Ghost Table）**：
    - 指代码中仍然引用，但在当前 Schema 中已经不存在的表；
    - 典型表现：某个函数/模块的 SQL 使用某表名，Schema 里没有该表定义；
    - 这类问题一旦执行，将直接造成运行时错误（500）。
    - 示例：`pos_invoice_payments` 就是当前已确认的幽灵表引用。
  - **旧表（Legacy Table）**：
    - 指数据库中仍存在，但已经不再被现有链路使用的表；
    - 注意：旧表**不一定以 `old_` 前缀命名**，很多旧表是按“新风格命名”保留下来的（例如早期版本的设计残留），只是升级链路时改用了新表而未删除旧表；
    - 旧表在短期内不会直接导致错误，但会让 Schema 与实际业务不一致，增加维护成本。
- 审计策略：
  - 幽灵表：
    - 通过“代码引用 vs 当前 Schema”对比，可以发现代码中使用但 Schema 中不存在的表名；
    - POS 线 L4-2B 已经找到一个典型案例（ISSUE-POS-DB-001），全系统（POS/KDS/CPSYS）完成 L4-2B 后，需要统一汇总所有幽灵表引用并逐一清理。
  - 旧表：
    - 不能仅依赖命名规则（例如 `old_` 前缀），因为历史上旧表也可能已经按新命名风格；
    - 需要结合：
      - Schema 粗筛（L4-2A）；
      - 各线代码引用审计（L4-2B）；
    - 得出“在 Schema 存在但各线代码均不再引用”的表清单，然后以“改名 / 降权 / 观察期 / 最终清理”的节奏处理。
- 当前状态：
  - POS 线 L4-2B：已发现一个幽灵表引用（ISSUE-POS-DB-001）；
  - 全系统幽灵表与旧表的最终清单，待 POS / CPSYS / KDS 各线 L4-2B 完成后统一整理。
